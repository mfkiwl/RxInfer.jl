<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Nonlinear Smoothing: Rabbit Population · RxInfer.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://biaslab.github.io/RxInfer.jl/examples/Nonlinear Rabbit Population/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/theme.css" rel="stylesheet" type="text/css"/><link href="../../assets/header.css" rel="stylesheet" type="text/css"/><script src="../../assets/header.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.svg" alt="RxInfer.jl logo"/><img class="docs-dark-only" src="../../assets/logo-dark.svg" alt="RxInfer.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">RxInfer.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">User guide</span><ul><li><a class="tocitem" href="../../manuals/getting-started/">Getting started</a></li><li><a class="tocitem" href="../../manuals/model-specification/">Model specification</a></li><li><a class="tocitem" href="../../manuals/constraints-specification/">Constraints specification</a></li><li><a class="tocitem" href="../../manuals/meta-specification/">Meta specification</a></li><li><input class="collapse-toggle" id="menuitem-2-5" type="checkbox"/><label class="tocitem" for="menuitem-2-5"><span class="docs-label">Inference specification</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manuals/inference/overview/">Overview</a></li><li><a class="tocitem" href="../../manuals/inference/inference/">Static dataset</a></li><li><a class="tocitem" href="../../manuals/inference/rxinference/">Real-time dataset / reactive inference</a></li><li><a class="tocitem" href="../../manuals/inference/manual/">Manual inference specification</a></li></ul></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../library/functional-forms/">Built-in functional form constraints</a></li><li><a class="tocitem" href="../../library/model-specification/">Model specification</a></li><li><a class="tocitem" href="../../library/bethe-free-energy/">Bethe Free Energy</a></li><li><a class="tocitem" href="../../library/exported-methods/">Exported methods</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../Coin Toss Model/">Coin toss model (Beta-Bernoulli)</a></li><li><a class="tocitem" href="../Linear Regression/">Bayesian Linear Regression</a></li><li><a class="tocitem" href="../Active Inference Mountain car/">Active Inference Mountain car</a></li><li><a class="tocitem" href="../Assessing People Skills/">Assessing People’s Skills</a></li><li><a class="tocitem" href="../Gaussian Linear Dynamical System/">Gaussian Linear Dynamical System</a></li><li><a class="tocitem" href="../Hidden Markov Model/">Ensemble Learning of a Hidden Markov Model</a></li><li><a class="tocitem" href="../Autoregressive Model/">Autoregressive Model</a></li><li><a class="tocitem" href="../Hierarchical Gaussian Filter/">Hierarchical Gaussian Filter</a></li><li><a class="tocitem" href="../Bayesian ARMA/">Bayesian ARMA model</a></li><li><a class="tocitem" href="../Infinite Data Stream/">Infinite Data Stream</a></li><li><a class="tocitem" href="../Identification Problem/">System Identification Problem</a></li><li><a class="tocitem" href="../Gaussian Mixture Univariate/">Univariate Gaussian Mixture Model</a></li><li><a class="tocitem" href="../Gaussian Mixtures Multivariate/">Multivariate Gaussian Mixture Model</a></li><li><a class="tocitem" href="../Gamma Mixture/">Gamma Mixture Model</a></li><li><a class="tocitem" href="../Global Parameter Optimisation/">Global Parameter Optimisation</a></li><li><a class="tocitem" href="../Invertible Neural Network Tutorial/">Invertible neural networks: a tutorial</a></li><li><a class="tocitem" href="../Conjugate-Computational Variational Message Passing/">Conjugate-Computational Variational Message Passing (CVI)</a></li><li><a class="tocitem" href="../GPRegression by SSM/">Solve GP regression by SDE</a></li><li><a class="tocitem" href="../Nonlinear Noisy Pendulum/">Nonlinear Smoothing: Noisy Pendulum</a></li><li class="is-active"><a class="tocitem" href>Nonlinear Smoothing: Rabbit Population</a><ul class="internal"><li><a class="tocitem" href="#.-Rabbit-population-size"><span>1. Rabbit population size</span></a></li></ul></li><li><a class="tocitem" href="../Nonlinear Virus Spread/">Nonlinear Virus Spread</a></li><li><a class="tocitem" href="../Nonlinear Sensor Fusion/">Nonlinear Sensor Fusion</a></li><li><a class="tocitem" href="../Kalman filter with LSTM network driven dynamic/">Kalman filter with LSTM network driven dynamic</a></li><li><a class="tocitem" href="../Handling Missing Data/">Handling Missing Data</a></li><li><a class="tocitem" href="../Custom nonlinear node/">Custom Nonlinear Node</a></li><li><a class="tocitem" href="../Probit Model (EP)/">Probit Model (EP)</a></li><li><a class="tocitem" href="../RTS vs BIFM Smoothing/">RTS vs BIFM Smoothing</a></li><li><a class="tocitem" href="../Advanced Tutorial/">Advanced Tutorial</a></li></ul></li><li><span class="tocitem">Contributing</span><ul><li><a class="tocitem" href="../../contributing/overview/">Overview</a></li><li><a class="tocitem" href="../../contributing/new-example/">Adding a new example</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Nonlinear Smoothing: Rabbit Population</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Nonlinear Smoothing: Rabbit Population</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/biaslab/RxInfer.jl/blob/main/docs/src/examples/Nonlinear Rabbit Population.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p>This example has been auto-generated from the <a href="https://github.com/biaslab/RxInfer.jl/tree/main/examples"><code>examples/</code></a> folder at GitHub repository.</p><h1 id="examples-nonlinear-smoothing:-rabbit-population"><a class="docs-heading-anchor" href="#examples-nonlinear-smoothing:-rabbit-population">Nonlinear Smoothing: Rabbit Population</a><a id="examples-nonlinear-smoothing:-rabbit-population-1"></a><a class="docs-heading-anchor-permalink" href="#examples-nonlinear-smoothing:-rabbit-population" title="Permalink"></a></h1><pre><code class="language-julia hljs"># Activate local environment, see `Project.toml`
import Pkg; Pkg.activate(&quot;.&quot;); Pkg.instantiate();</code></pre><p>In this demo, we will look at dynamical systems with nonlinear state transitions. We will start with a one-dimensional problem; the number of rabbits on an island. This problem seems overly simple, but it is a good way to demonstrate the basic pipeline of working with RxInfer.</p><h2 id=".-Rabbit-population-size"><a class="docs-heading-anchor" href="#.-Rabbit-population-size">1. Rabbit population size</a><a id=".-Rabbit-population-size-1"></a><a class="docs-heading-anchor-permalink" href="#.-Rabbit-population-size" title="Permalink"></a></h2><p>We consider a model for the number of rabbits on a particular island. We assume the population size follows a <a href="https://en.wikipedia.org/wiki/Logistic_map">logistic map</a>: initially, it grows exponentially, but as the number of rabbits increases, so does the number of foxes. At some point, population size will drop again. But as the number of rabbits drops, so does the number of foxes, which means the number of rabbits can grow again. We express the change in the population with the following nonlinear state transition:</p><p class="math-container">\[x_{t+1} = r \cdot x_t(1-x_t)\]</p><p>where <span>$r$</span> is a fertility parameter, reflecting how fast the number of rabbits can grow. <span>$x$</span> does not reflect the number of rabbits, but rather the proportion of rabbits relative to a maximum population <span>$N$</span> on the island. This means <span>$x$</span> is bounded in the interval <span>$[0,1]$</span>.</p><p>Every month, we count the number of rabbits <span>$y_t$</span>. We assume that these counts are noisy: sometimes, we count one rabbit twice and sometimes, we miss one. This noise is expressed as a Gaussian distribution centered at <span>$0$</span>, with some measurement noise precision.</p><pre><code class="language-julia hljs"># Import libraries to julia workspace
using RxInfer, Plots, Distributions, StableRNGs</code></pre><pre><code class="language-julia hljs"># Range for observation noise
rng = StableRNG(1234);

# Length of time-series
T = 36

# Maximum population size
N = 100

# Fertility parameter (0 &lt; r &lt; 4)
fertility = 3.2

# Measurement noise precision
noise_precision = 0.01

# Initial proportion of rabbits
x0 = 0.04

# Initialize data array
states = zeros(T,)
observations = zeros(T,)

# Initialize previous state variable
prev_state = x0

for t = 1:T
    
    # State transition
    global states[t] = fertility*prev_state*(1-prev_state)
    
    # Observation likelihood
    global observations[t] = max(round(N*states[t] .+ sqrt(inv(noise_precision))*randn(rng,)[1]), 0.)
    
    # Update &quot;previous state&quot;
    global prev_state = states[t]
    
end</code></pre><pre><code class="language-julia hljs"># Inspect data
plot(1:T, states.*N, xlabel = &quot;t (months)&quot;, ylabel = &quot;rabbits&quot;, label = &quot;true population&quot;)
scatter!(1:T, observations, ylims = [0, N], label = &quot;observed&quot;, legend = :bottomright)</code></pre><p><img src="../../assets/examples/Nonlinear Rabbit Population_4_1.png" alt/></p><h3 id="Model-specification"><a class="docs-heading-anchor" href="#Model-specification">Model specification</a><a id="Model-specification-1"></a><a class="docs-heading-anchor-permalink" href="#Model-specification" title="Permalink"></a></h3><p>We define a state-space model, consisting of a state transition between <span>$x_{t-1}$</span> and <span>$x_t$</span> and an observation likelihood between <span>$y_t$</span> and <span>$x_t$</span>. These are conditional distributions, which we model with certain parametric distributions. In this case, mostly Gaussian distributions.</p><ul><li><p>The states are the proportion of rabbits relative to a maximum N. To model the rabbit counts, we must multiply the states with the maximum population number <span>$N$</span>. Furthermore, we said that the rabbit counts are noisy (see &#39;Generate data&#39; section). We assumed that we were counting some rabbits twice and missed others. That justifies using a white noise term: the current rabbit count is Gaussian distributed centered on the current state times the maximum population. For the sake of simplicity in this demo, we assume that we know the size of the noise. It is however straightforward to add a prior for measurement noise and estimate it simultaneously.</p></li><li><p>The state transition that we defined above (the <a href="https://en.wikipedia.org/wiki/Logistic_map">logistic map</a>) is nonlinear in nature (polynomial order 2). To capture this mapping, we have to use a &quot;Delta&quot; node. The &quot;Delta{Unscented}&quot; node performs an unscented transform to approximate the given function (exact up to polynomial order 3) and approximates the result with a Gaussian distribution.</p></li><li><p>We have to specify a prior distribution for the states. Below, we choose a Gaussian distribution, but this is actually not completely valid. In a model using the logistic map, the states are confined to the interval <span>$[0, 1]$</span>. We would therefore have to use a bounded distribution, such as the <a href="https://en.wikipedia.org/wiki/Beta_distribution">Beta</a>. However, a Beta process is much more complicated than a Gaussian process and we will therefore avoid it here.</p></li><li><p>We have to specify a prior for the fertility parameter <span>$r$</span>. It is supposed to be a strictly positive number, so ideally we would use something like a <a href="https://en.wikipedia.org/wiki/Gamma_distribution">Gamma</a> or <a href="https://en.wikipedia.org/wiki/Log-normal_distribution">log-Normal</a> distribution. However, this, again, complicates inference and we have therefore opted for a Gaussian distribution.</p></li></ul><p>We are going to specify the state-space model in recursive form, i.e. we only specify the previous state, the state transition and the likelihood, and update estimates as observations arrive. We will probably observe that our estimates start out relatively poor but improve over time. </p><pre><code class="language-julia hljs">g(x, r) = r*x*(1 - x)</code></pre><pre><code class="nohighlight hljs">g (generic function with 1 method)</code></pre><pre><code class="language-julia hljs">@model function rabbit_population(n, precision = 10)
    x = randomvar(n)
    y = datavar(Float64, n)

    r ~ Normal(μ = 1.0, σ² = 10.0)
    x_0 ~ Normal(μ = 0.5, σ² = 2.0)

    x_prev = x_0
    for i in 1:n
        x[i] ~ g(x_prev, r)
        y[i] ~ Normal(μ = N * x[i], γ = precision)
        
        x_prev = x[i]
    end

end</code></pre><pre><code class="language-julia hljs">meta = @meta begin 
    # `meta` specifies the approximation method, which will
    # be used to approximate the nonlinearity
    g() -&gt; Unscented(alpha = 1.1)
end</code></pre><pre><code class="nohighlight hljs">Meta specification:
  g() -&gt; Unscented{Float64, Float64, Float64, Nothing}(1.1, 2.0, 0.0, nothi
ng)
Options:
  warn = true</code></pre><pre><code class="language-julia hljs">result = inference(
    model = rabbit_population(length(observations), noise_precision,), 
    meta = meta,
    initmessages = (r = NormalMeanVariance(1.0, 1.0), ), 
    data = (y = observations,), 
    showprogress = false,
    returnvars = KeepLast(),
    iterations = 15
)</code></pre><pre><code class="nohighlight hljs">Inference results:
  Posteriors       | available for (x_0, r, x)</code></pre><p>Lets also check the inference results:</p><pre><code class="language-julia hljs">m_x_t, v_x_t = mean.(result.posteriors[:x]), cov.(result.posteriors[:x]);</code></pre><pre><code class="language-julia hljs"># Plot estimate of fertility parameter r
using StatsPlots

# Plot true states and overlay estimates
p1 = plot(1:T, states, linewidth=2, ylims=[0., 1.], xlabel=&quot;time (months)&quot;, ylabel=&quot;x (proportion rabbits)&quot;, label=&quot;true&quot;, legend=:bottomright)
p1 = plot!(p1, 1:T, m_x_t, linewidth=4, color=&quot;red&quot;, ribbon=[sqrt.(v_x_t) sqrt.(v_x_t)], alpha=0.6, label=&quot;estimated&quot;)
p1 = scatter!(p1, 1:T, observations./N, color=&quot;black&quot;, markersize=3, label=&quot;observed&quot;, legend=:bottomright)
p1 = title!(p1, &quot;Rabbit population size, relative to max&quot;)

estimated = Normal(mean(result.posteriors[:r]), std(result.posteriors[:r]))
prior = Normal(1.0, 1.0)
p2 = plot(prior, label=&quot;prior&quot;, fillalpha=0.3, fillrange = 0, legend = :topleft)
p2 = plot!(p2, estimated, label=&quot;posterior&quot;, fillalpha=0.3, fillrange = 0)
p2 = vline!(p2, [ fertility ], linecolor = :red, linestyle = :dash, label=&quot;true&quot;)

p2 = title!(p2, &quot;Estimate of fertility parameter&quot;)
p2 = xlabel!(p2, &quot;r (fertility)&quot;)
p2 = ylabel!(p2, &quot;probability density&quot;)
p2 = xlims!(p2, -1, 4)

plot(p1, p2, layout = @layout([ a; b ]), size = (750, 600))</code></pre><p><img src="../../assets/examples/Nonlinear Rabbit Population_10_1.png" alt/></p><p>As we can see the inferred results match the real hidden state with high precision, as well as the inferred fertility parameter.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Nonlinear Noisy Pendulum/">« Nonlinear Smoothing: Noisy Pendulum</a><a class="docs-footer-nextpage" href="../Nonlinear Virus Spread/">Nonlinear Virus Spread »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 9 December 2022 16:28">Friday 9 December 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
